{% extends "base.html" %}

{% block title %}Exploit Management - PegaSpy{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-bomb"></i> Exploit Management</h2>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#launchExploitModal">
        <i class="fas fa-rocket"></i> Launch Exploit
    </button>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Active Exploits</h5>
                <h2 class="text-warning" id="activeExploits">{{ active_exploits|length }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Success Rate</h5>
                <h2 class="text-success" id="successRate">87.5%</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Avg. Infection Time</h5>
                <h2 class="text-info" id="avgTime">2.3s</h2>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Stealth Rating</h5>
                <h2 class="text-success" id="stealthRating">98.2%</h2>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Available Exploits</h5>
            </div>
            <div class="card-body">
                <div class="list-group">
                    {% for exploit_type in exploit_types %}
                    <div class="list-group-item bg-dark border-success d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">{{ exploit_type }}</h6>
                            <small class="text-muted">
                                {% if 'iMessage' in exploit_type %}
                                Zero-click iOS exploit via iMessage
                                {% elif 'WhatsApp' in exploit_type %}
                                Media-based Android/iOS exploit
                                {% elif 'Telegram' in exploit_type %}
                                Sticker-based cross-platform exploit
                                {% endif %}
                            </small>
                        </div>
                        <div>
                            <span class="badge bg-success me-2">
                                {% if 'iMessage' in exploit_type %}87%{% elif 'WhatsApp' in exploit_type %}72%{% else %}65%{% endif %}
                            </span>
                            <button class="btn btn-sm btn-primary" onclick="quickLaunch('{{ exploit_type }}')">
                                <i class="fas fa-rocket"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> Exploit Statistics</h5>
            </div>
            <div class="card-body">
                <canvas id="exploitChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5><i class="fas fa-history"></i> Exploit History</h5>
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-success btn-sm" onclick="filterExploits('all')">All</button>
                <button type="button" class="btn btn-outline-warning btn-sm" onclick="filterExploits('active')">Active</button>
                <button type="button" class="btn btn-outline-success btn-sm" onclick="filterExploits('successful')">Successful</button>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="filterExploits('failed')">Failed</button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-dark table-striped" id="exploitsTable">
                <thead>
                    <tr>
                        <th>Exploit ID</th>
                        <th>Target</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Success Probability</th>
                        <th>Launch Time</th>
                        <th>Duration</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for exploit in active_exploits.values() %}
                    <tr data-exploit-id="{{ exploit.id }}" data-status="{{ exploit.status }}">
                        <td><code>{{ exploit.id }}</code></td>
                        <td>{{ exploit.target_id }}</td>
                        <td>
                            <span class="badge bg-info">{{ exploit.exploit_type }}</span>
                        </td>
                        <td>
                            <span class="badge bg-{{ 'warning' if exploit.status == 'launching' else 'success' if exploit.status == 'successful' else 'danger' }}" id="status-{{ exploit.id }}">
                                {{ exploit.status.title() }}
                            </span>
                        </td>
                        <td>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: {{ exploit.success_probability }}%">
                                    {{ exploit.success_probability }}%
                                </div>
                            </div>
                        </td>
                        <td>{{ exploit.launch_time[:19] }}</td>
                        <td id="duration-{{ exploit.id }}">-</td>
                        <td>
                            <button class="btn btn-sm btn-info" onclick="viewExploitDetails('{{ exploit.id }}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="pauseExploit('{{ exploit.id }}')">
                                <i class="fas fa-pause"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="terminateExploit('{{ exploit.id }}')">
                                <i class="fas fa-stop"></i>
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center text-muted">
                            <i class="fas fa-inbox"></i> No exploits launched yet
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Launch Exploit Modal -->
<div class="modal fade" id="launchExploitModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-success">
                <h5 class="modal-title"><i class="fas fa-rocket"></i> Launch Exploit</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="launchExploitForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="targetSelect" class="form-label">Target</label>
                                <select class="form-select" id="targetSelect" required>
                                    <option value="">Select Target</option>
                                    <!-- Targets will be loaded dynamically -->
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="exploitType" class="form-label">Exploit Type</label>
                                <select class="form-select" id="exploitType" required>
                                    <option value="">Select Exploit</option>
                                    {% for exploit_type in exploit_types %}
                                    <option value="{{ exploit_type }}">{{ exploit_type }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="payloadType" class="form-label">Payload</label>
                                <select class="form-select" id="payloadType" required>
                                    <option value="">Select Payload</option>
                                    <option value="surveillance">Surveillance Package</option>
                                    <option value="data_exfil">Data Exfiltration</option>
                                    <option value="remote_access">Remote Access Trojan</option>
                                    <option value="keylogger">Keylogger</option>
                                    <option value="custom">Custom Payload</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="stealthLevel" class="form-label">Stealth Level</label>
                                <select class="form-select" id="stealthLevel">
                                    <option value="maximum">Maximum (Slower)</option>
                                    <option value="high" selected>High (Recommended)</option>
                                    <option value="medium">Medium (Faster)</option>
                                    <option value="low">Low (Fastest)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="persistenceLevel" class="form-label">Persistence</label>
                                <select class="form-select" id="persistenceLevel">
                                    <option value="temporary">Temporary (Session Only)</option>
                                    <option value="reboot" selected>Survive Reboot</option>
                                    <option value="permanent">Permanent (Firmware)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="selfDestruct" class="form-label">Self-Destruct Timer</label>
                                <select class="form-select" id="selfDestruct">
                                    <option value="0">Disabled</option>
                                    <option value="3600">1 Hour</option>
                                    <option value="86400" selected>24 Hours</option>
                                    <option value="604800">7 Days</option>
                                    <option value="2592000">30 Days</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="exploitNotes" class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" id="exploitNotes" rows="3" placeholder="Additional notes about this exploit"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-success">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="launchExploit()">Launch Exploit</button>
            </div>
        </div>
    </div>
</div>

<!-- Exploit Details Modal -->
<div class="modal fade" id="exploitDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark">
            <div class="modal-header border-success">
                <h5 class="modal-title"><i class="fas fa-eye"></i> Exploit Details</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="exploitDetailsContent">
                <!-- Exploit details will be loaded here -->
            </div>
            <div class="modal-footer border-success">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-warning" id="pauseExploitBtn">Pause</button>
                <button type="button" class="btn btn-danger" id="terminateExploitBtn">Terminate</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let activeExploits = {{ active_exploits|tojson }};

// Initialize exploit statistics chart
const ctx = document.getElementById('exploitChart').getContext('2d');
const exploitChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
        labels: ['Successful', 'Active', 'Failed'],
        datasets: [{
            data: [65, 25, 10],
            backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
            borderColor: ['#00ff00', '#ffaa00', '#ff0000'],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                labels: {
                    color: '#00ff00'
                }
            }
        }
    }
});

function loadTargets() {
    fetch('/api/targets')
        .then(response => response.json())
        .then(targets => {
            const select = document.getElementById('targetSelect');
            select.innerHTML = '<option value="">Select Target</option>';
            
            targets.forEach(target => {
                const option = document.createElement('option');
                option.value = target.id;
                option.textContent = `${target.phone_number} (${target.platform})`;
                select.appendChild(option);
            });
        })
        .catch(error => console.error('Error loading targets:', error));
}

function quickLaunch(exploitType) {
    document.getElementById('exploitType').value = exploitType;
    loadTargets();
    new bootstrap.Modal(document.getElementById('launchExploitModal')).show();
}

function launchExploit() {
    const targetId = document.getElementById('targetSelect').value;
    const exploitType = document.getElementById('exploitType').value;
    const payloadType = document.getElementById('payloadType').value;
    const stealthLevel = document.getElementById('stealthLevel').value;
    const persistenceLevel = document.getElementById('persistenceLevel').value;
    const selfDestruct = document.getElementById('selfDestruct').value;
    const notes = document.getElementById('exploitNotes').value;
    
    if (!targetId || !exploitType || !payloadType) {
        alert('Please fill in all required fields');
        return;
    }
    
    if (!confirm('Are you sure you want to launch this exploit? This action cannot be undone.')) {
        return;
    }
    
    const exploitData = {
        target_id: targetId,
        exploit_type: exploitType,
        payload_type: payloadType,
        stealth_level: stealthLevel,
        persistence_level: persistenceLevel,
        self_destruct: parseInt(selfDestruct),
        notes: notes
    };
    
    fetch('/api/exploits/launch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(exploitData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('launchExploitModal')).hide();
            alert('Exploit launched successfully!');
            location.reload();
        } else {
            alert('Failed to launch exploit: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to launch exploit');
    });
}

function viewExploitDetails(exploitId) {
    const exploit = activeExploits[exploitId];
    if (!exploit) return;
    
    const detailsContent = `
        <div class="row">
            <div class="col-md-6">
                <h6>Exploit Information</h6>
                <table class="table table-dark table-sm">
                    <tr><td>ID:</td><td><code>${exploit.id}</code></td></tr>
                    <tr><td>Target:</td><td>${exploit.target_id}</td></tr>
                    <tr><td>Type:</td><td>${exploit.exploit_type}</td></tr>
                    <tr><td>Status:</td><td><span class="badge bg-warning">${exploit.status}</span></td></tr>
                    <tr><td>Success Probability:</td><td>${exploit.success_probability}%</td></tr>
                    <tr><td>Launch Time:</td><td>${exploit.launch_time}</td></tr>
                </table>
            </div>
            <div class="col-md-6">
                <h6>Execution Progress</h6>
                <div class="mb-3">
                    <label>Payload Delivery</label>
                    <div class="progress">
                        <div class="progress-bar bg-success" style="width: 100%">Complete</div>
                    </div>
                </div>
                <div class="mb-3">
                    <label>Exploitation</label>
                    <div class="progress">
                        <div class="progress-bar bg-warning" style="width: 75%">In Progress</div>
                    </div>
                </div>
                <div class="mb-3">
                    <label>Persistence</label>
                    <div class="progress">
                        <div class="progress-bar bg-secondary" style="width: 25%">Pending</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="mt-3">
            <h6>Real-time Log</h6>
            <div class="bg-black p-3" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                <div class="text-success">[${new Date().toISOString()}] Exploit launched against target ${exploit.target_id}</div>
                <div class="text-info">[${new Date().toISOString()}] Payload delivery initiated</div>
                <div class="text-success">[${new Date().toISOString()}] Target device contacted successfully</div>
                <div class="text-warning">[${new Date().toISOString()}] Exploiting vulnerability CVE-2023-XXXX</div>
                <div class="text-info">[${new Date().toISOString()}] Bypass attempt: ASLR</div>
                <div class="text-success">[${new Date().toISOString()}] ASLR bypass successful</div>
                <div class="text-warning">[${new Date().toISOString()}] Establishing persistence...</div>
            </div>
        </div>
    `;
    
    document.getElementById('exploitDetailsContent').innerHTML = detailsContent;
    document.getElementById('pauseExploitBtn').onclick = () => pauseExploit(exploitId);
    document.getElementById('terminateExploitBtn').onclick = () => terminateExploit(exploitId);
    
    new bootstrap.Modal(document.getElementById('exploitDetailsModal')).show();
}

function pauseExploit(exploitId) {
    if (confirm('Pause this exploit?')) {
        // Update status in UI
        updateExploitStatus(exploitId, 'paused');
        alert('Exploit paused');
    }
}

function terminateExploit(exploitId) {
    if (confirm('Terminate this exploit? This will trigger self-destruct on the target.')) {
        // Update status in UI
        updateExploitStatus(exploitId, 'terminated');
        alert('Exploit terminated and self-destruct initiated');
    }
}

function updateExploitStatus(exploitId, status) {
    const statusElement = document.getElementById(`status-${exploitId}`);
    if (statusElement) {
        statusElement.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        statusElement.className = `badge bg-${status === 'paused' ? 'warning' : status === 'terminated' ? 'danger' : 'success'}`;
    }
    
    if (activeExploits[exploitId]) {
        activeExploits[exploitId].status = status;
    }
}

function filterExploits(filter) {
    const rows = document.querySelectorAll('#exploitsTable tbody tr');
    
    rows.forEach(row => {
        const status = row.getAttribute('data-status');
        if (filter === 'all' || status === filter) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update button states
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

// Update durations
function updateDurations() {
    Object.values(activeExploits).forEach(exploit => {
        const launchTime = new Date(exploit.launch_time);
        const now = new Date();
        const duration = Math.floor((now - launchTime) / 1000);
        
        const durationElement = document.getElementById(`duration-${exploit.id}`);
        if (durationElement) {
            const minutes = Math.floor(duration / 60);
            const seconds = duration % 60;
            durationElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
    });
}

// Load targets when modal opens
document.getElementById('launchExploitModal').addEventListener('show.bs.modal', loadTargets);

// Update durations every second
setInterval(updateDurations, 1000);

// Socket.IO for real-time updates
const socket = io();
socket.on('exploit_launched', function(data) {
    location.reload(); // Refresh to show new exploit
});

socket.on('exploit_update', function(data) {
    if (data.exploit_id && activeExploits[data.exploit_id]) {
        updateExploitStatus(data.exploit_id, data.status);
    }
});
</script>
{% endblock %}