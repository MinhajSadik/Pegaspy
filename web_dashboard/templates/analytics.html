{% extends "base.html" %}

{% block title %}Analytics & Reporting - PegaSpy{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-chart-line"></i> Analytics & Reporting</h2>
    <div class="btn-group" role="group">
        <button class="btn btn-primary" onclick="generateReport()">
            <i class="fas fa-file-alt"></i> Generate Report
        </button>
        <button class="btn btn-info" onclick="exportData()">
            <i class="fas fa-download"></i> Export Data
        </button>
        <button class="btn btn-warning" onclick="clearAnalytics()">
            <i class="fas fa-trash"></i> Clear Data
        </button>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Success Rate</h5>
                <h2 class="text-success">{{ analytics.success_rate }}%</h2>
                <small class="text-muted">Overall</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Avg. Infection Time</h5>
                <h2 class="text-info">{{ analytics.avg_infection_time }}</h2>
                <small class="text-muted">Zero-click</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Stealth Rating</h5>
                <h2 class="text-success">{{ analytics.stealth_rating }}%</h2>
                <small class="text-muted">Undetected</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body text-center">
                <h5 class="card-title">Data Collected</h5>
                <h2 class="text-warning">{{ analytics.data_collected }}</h2>
                <small class="text-muted">Total</small>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-chart-area"></i> Exploit Success Trends</h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-success" onclick="updateChart('24h')">24H</button>
                        <button type="button" class="btn btn-outline-success active" onclick="updateChart('7d')">7D</button>
                        <button type="button" class="btn btn-outline-success" onclick="updateChart('30d')">30D</button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <canvas id="successTrendsChart" height="100"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-globe"></i> Geographic Distribution</h5>
            </div>
            <div class="card-body">
                <canvas id="geoChart" height="200"></canvas>
                <div class="mt-3">
                    {% for region, percentage in analytics.geographic_distribution.items() %}
                    <div class="d-flex justify-content-between mb-2">
                        <span>{{ region }}</span>
                        <span class="text-success">{{ percentage }}%</span>
                    </div>
                    <div class="progress mb-2" style="height: 5px;">
                        <div class="progress-bar bg-success" style="width: {{ percentage }}%"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-mobile-alt"></i> Platform Analysis</h5>
            </div>
            <div class="card-body">
                <canvas id="platformChart" height="150"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-bug"></i> Exploit Type Performance</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-dark table-sm">
                        <thead>
                            <tr>
                                <th>Exploit Type</th>
                                <th>Success Rate</th>
                                <th>Avg. Time</th>
                                <th>Usage</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>iMessage Zero-Click</td>
                                <td><span class="text-success">87.5%</span></td>
                                <td>2.3s</td>
                                <td>
                                    <div class="progress" style="height: 15px;">
                                        <div class="progress-bar bg-success" style="width: 65%">65%</div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>WhatsApp Media</td>
                                <td><span class="text-warning">72.1%</span></td>
                                <td>4.7s</td>
                                <td>
                                    <div class="progress" style="height: 15px;">
                                        <div class="progress-bar bg-warning" style="width: 25%">25%</div>
                                    </div>
                                </td>
                            </tr>
                            <tr>
                                <td>Telegram Sticker</td>
                                <td><span class="text-info">65.3%</span></td>
                                <td>6.1s</td>
                                <td>
                                    <div class="progress" style="height: 15px;">
                                        <div class="progress-bar bg-info" style="width: 10%">10%</div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-clock"></i> Real-time Activity Monitor</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <canvas id="realTimeChart" height="80"></canvas>
                    </div>
                    <div class="col-md-4">
                        <div class="bg-black p-3" style="height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;" id="realTimeLog">
                            <!-- Real-time activity log -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-shield-alt"></i> Security Metrics</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Detection Evasion</span>
                        <span class="text-success">98.7%</span>
                    </div>
                    <div class="progress mt-1">
                        <div class="progress-bar bg-success" style="width: 98.7%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Attribution Resistance</span>
                        <span class="text-success">96.2%</span>
                    </div>
                    <div class="progress mt-1">
                        <div class="progress-bar bg-success" style="width: 96.2%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Persistence Rate</span>
                        <span class="text-warning">89.4%</span>
                    </div>
                    <div class="progress mt-1">
                        <div class="progress-bar bg-warning" style="width: 89.4%"></div>
                    </div>
                </div>
                <div class="mb-3">
                    <div class="d-flex justify-content-between">
                        <span>Self-Destruct Success</span>
                        <span class="text-success">100%</span>
                    </div>
                    <div class="progress mt-1">
                        <div class="progress-bar bg-success" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-database"></i> Data Exfiltration Stats</h5>
            </div>
            <div class="card-body">
                <canvas id="dataChart" height="150"></canvas>
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-4">
                            <h6 class="text-info">Messages</h6>
                            <h5>1.2M</h5>
                        </div>
                        <div class="col-4">
                            <h6 class="text-warning">Photos</h6>
                            <h5>45K</h5>
                        </div>
                        <div class="col-4">
                            <h6 class="text-success">Contacts</h6>
                            <h5>8.7K</h5>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Generation Modal -->
<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark">
            <div class="modal-header border-success">
                <h5 class="modal-title"><i class="fas fa-file-alt"></i> Generate Report</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reportForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reportType" class="form-label">Report Type</label>
                                <select class="form-select" id="reportType">
                                    <option value="summary">Executive Summary</option>
                                    <option value="detailed">Detailed Analysis</option>
                                    <option value="technical">Technical Report</option>
                                    <option value="custom">Custom Report</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="dateRange" class="form-label">Date Range</label>
                                <select class="form-select" id="dateRange">
                                    <option value="24h">Last 24 Hours</option>
                                    <option value="7d" selected>Last 7 Days</option>
                                    <option value="30d">Last 30 Days</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reportFormat" class="form-label">Format</label>
                                <select class="form-select" id="reportFormat">
                                    <option value="pdf">PDF</option>
                                    <option value="html">HTML</option>
                                    <option value="json">JSON</option>
                                    <option value="csv">CSV</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Include Sections</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeExploits" checked>
                                    <label class="form-check-label" for="includeExploits">Exploit Statistics</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeTargets" checked>
                                    <label class="form-check-label" for="includeTargets">Target Analysis</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeC2" checked>
                                    <label class="form-check-label" for="includeC2">C2 Infrastructure</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="includeSecurity">
                                    <label class="form-check-label" for="includeSecurity">Security Metrics</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-success">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="generateReportFile()">Generate Report</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Chart configurations
const chartOptions = {
    responsive: true,
    scales: {
        y: {
            beginAtZero: true,
            ticks: { color: '#00ff00' }
        },
        x: {
            ticks: { color: '#00ff00' }
        }
    },
    plugins: {
        legend: {
            labels: { color: '#00ff00' }
        }
    }
};

// Success Trends Chart
const successTrendsCtx = document.getElementById('successTrendsChart').getContext('2d');
const successTrendsChart = new Chart(successTrendsCtx, {
    type: 'line',
    data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
        datasets: [{
            label: 'Success Rate (%)',
            data: [85, 87, 89, 86, 88, 90, 87],
            borderColor: '#00ff00',
            backgroundColor: 'rgba(0, 255, 0, 0.1)',
            tension: 0.4
        }, {
            label: 'Attempts',
            data: [45, 52, 38, 67, 43, 29, 56],
            borderColor: '#ffc107',
            backgroundColor: 'rgba(255, 193, 7, 0.1)',
            tension: 0.4
        }]
    },
    options: chartOptions
});

// Geographic Distribution Chart
const geoCtx = document.getElementById('geoChart').getContext('2d');
const geoChart = new Chart(geoCtx, {
    type: 'doughnut',
    data: {
        labels: ['North America', 'Europe', 'Asia', 'Other'],
        datasets: [{
            data: [45, 30, 20, 5],
            backgroundColor: ['#28a745', '#17a2b8', '#ffc107', '#dc3545'],
            borderColor: ['#00ff00', '#00aaff', '#ffaa00', '#ff0000'],
            borderWidth: 2
        }]
    },
    options: {
        responsive: true,
        plugins: {
            legend: {
                labels: { color: '#00ff00' }
            }
        }
    }
});

// Platform Analysis Chart
const platformCtx = document.getElementById('platformChart').getContext('2d');
const platformChart = new Chart(platformCtx, {
    type: 'bar',
    data: {
        labels: ['iOS 15.x', 'iOS 14.x', 'Android 12', 'Android 11', 'Android 10'],
        datasets: [{
            label: 'Successful Exploits',
            data: [156, 89, 134, 78, 45],
            backgroundColor: 'rgba(0, 255, 0, 0.7)',
            borderColor: '#00ff00',
            borderWidth: 1
        }]
    },
    options: chartOptions
});

// Real-time Activity Chart
const realTimeCtx = document.getElementById('realTimeChart').getContext('2d');
let realTimeData = Array(20).fill(0);
const realTimeChart = new Chart(realTimeCtx, {
    type: 'line',
    data: {
        labels: Array(20).fill('').map((_, i) => `-${19-i}s`),
        datasets: [{
            label: 'Active Exploits',
            data: realTimeData,
            borderColor: '#00ff00',
            backgroundColor: 'rgba(0, 255, 0, 0.1)',
            tension: 0.4,
            fill: true
        }]
    },
    options: {
        responsive: true,
        animation: false,
        scales: {
            y: {
                beginAtZero: true,
                max: 10,
                ticks: { color: '#00ff00' }
            },
            x: {
                ticks: { color: '#00ff00' }
            }
        },
        plugins: {
            legend: {
                labels: { color: '#00ff00' }
            }
        }
    }
});

// Data Exfiltration Chart
const dataCtx = document.getElementById('dataChart').getContext('2d');
const dataChart = new Chart(dataCtx, {
    type: 'radar',
    data: {
        labels: ['Messages', 'Photos', 'Contacts', 'Location', 'Calls', 'Apps'],
        datasets: [{
            label: 'Data Types Collected',
            data: [95, 78, 89, 67, 45, 82],
            borderColor: '#00ff00',
            backgroundColor: 'rgba(0, 255, 0, 0.2)',
            pointBackgroundColor: '#00ff00'
        }]
    },
    options: {
        responsive: true,
        scales: {
            r: {
                beginAtZero: true,
                max: 100,
                ticks: { color: '#00ff00' },
                grid: { color: '#333' },
                pointLabels: { color: '#00ff00' }
            }
        },
        plugins: {
            legend: {
                labels: { color: '#00ff00' }
            }
        }
    }
});

// Real-time updates
function updateRealTimeChart() {
    // Simulate real-time data
    const newValue = Math.floor(Math.random() * 8) + 1;
    realTimeData.shift();
    realTimeData.push(newValue);
    
    realTimeChart.data.datasets[0].data = realTimeData;
    realTimeChart.update('none');
    
    // Update real-time log
    const log = document.getElementById('realTimeLog');
    const timestamp = new Date().toISOString();
    const logEntry = document.createElement('div');
    logEntry.className = 'text-success';
    logEntry.innerHTML = `[${timestamp.substr(11, 8)}] ${newValue} active exploits`;
    
    log.insertBefore(logEntry, log.firstChild);
    
    // Keep only last 10 entries
    while (log.children.length > 10) {
        log.removeChild(log.lastChild);
    }
}

function updateChart(period) {
    // Update chart data based on selected period
    let newData, newLabels;
    
    switch(period) {
        case '24h':
            newLabels = Array(24).fill('').map((_, i) => `${i}:00`);
            newData = Array(24).fill(0).map(() => Math.floor(Math.random() * 20) + 70);
            break;
        case '7d':
            newLabels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
            newData = [85, 87, 89, 86, 88, 90, 87];
            break;
        case '30d':
            newLabels = Array(30).fill('').map((_, i) => `Day ${i+1}`);
            newData = Array(30).fill(0).map(() => Math.floor(Math.random() * 15) + 80);
            break;
    }
    
    successTrendsChart.data.labels = newLabels;
    successTrendsChart.data.datasets[0].data = newData;
    successTrendsChart.update();
    
    // Update button states
    document.querySelectorAll('.btn-group button').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
}

function generateReport() {
    new bootstrap.Modal(document.getElementById('reportModal')).show();
}

function generateReportFile() {
    const reportType = document.getElementById('reportType').value;
    const dateRange = document.getElementById('dateRange').value;
    const format = document.getElementById('reportFormat').value;
    
    // Simulate report generation
    alert(`Generating ${reportType} report for ${dateRange} in ${format} format...`);
    
    // Close modal
    bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();
    
    // Simulate download after delay
    setTimeout(() => {
        const filename = `pegaspy_report_${Date.now()}.${format}`;
        alert(`Report generated: ${filename}`);
    }, 2000);
}

function exportData() {
    if (confirm('Export all analytics data? This may take a few minutes.')) {
        alert('Data export initiated. You will receive a download link shortly.');
        
        // Simulate export process
        setTimeout(() => {
            const filename = `pegaspy_analytics_${Date.now()}.zip`;
            alert(`Data exported: ${filename}`);
        }, 3000);
    }
}

function clearAnalytics() {
    if (confirm('Clear all analytics data? This action cannot be undone.')) {
        if (confirm('Are you absolutely sure? All historical data will be lost.')) {
            alert('Analytics data cleared successfully.');
            
            // Reset charts to zero
            successTrendsChart.data.datasets[0].data = Array(7).fill(0);
            successTrendsChart.update();
            
            platformChart.data.datasets[0].data = Array(5).fill(0);
            platformChart.update();
            
            // Clear real-time log
            document.getElementById('realTimeLog').innerHTML = '';
        }
    }
}

// Initialize real-time updates
setInterval(updateRealTimeChart, 2000);

// Socket.IO for real-time updates
const socket = io();
socket.on('analytics_update', function(data) {
    // Handle real-time analytics updates
    console.log('Analytics update received:', data);
});

// Initialize with some sample real-time log entries
document.addEventListener('DOMContentLoaded', function() {
    const log = document.getElementById('realTimeLog');
    const sampleEntries = [
        'Exploit launched against target_001',
        'Data exfiltration completed: 2.3MB',
        'New target added to campaign',
        'C2 node rotation completed',
        'Stealth mode activated'
    ];
    
    sampleEntries.forEach((entry, i) => {
        const div = document.createElement('div');
        div.className = 'text-info';
        const time = new Date(Date.now() - (i * 30000)).toISOString().substr(11, 8);
        div.innerHTML = `[${time}] ${entry}`;
        log.appendChild(div);
    });
});
</script>
{% endblock %}